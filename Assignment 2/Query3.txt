with inside (name, Nkey, Rkey, value) as (SELECT N.N_NAME, N.N_NATIONKEY, N.N_REGIONKEY, SUM(L.L_QUANTITY*(L.L_EXTENDEDPRICE - L.L_DISCOUNT)) as s
from NATION N, LINEITEM L, SUPPLIER S, CUSTOMER C, ORDERS O, NATION N1
where (S.S_NATIONKEY == N.N_NATIONKEY and S.S_SUPPKEY == L.L_SUPPKEY
           and C.C_CUSTKEY == O.O_CUSTKEY and O.O_ORDERKEY == L.L_ORDERKEY
            and N1.N_NATIONKEY == C.C_NATIONKEY and N.N_REGIONKEY == N1.N_REGIONKEY)
group by N.N_NATIONKEY)
--main clause
SELECT I.name, I.value, SUM(L1.L_QUANTITY*(L1.L_EXTENDEDPRICE - L1.L_DISCOUNT)) as s1
from NATION N1, LINEITEM L1, SUPPLIER S1, CUSTOMER C1, ORDERS O1, inside as I
where (N1.N_NATIONKEY == C1.C_NATIONKEY and C1.C_CUSTKEY == O1.O_CUSTKEY and O1.O_ORDERKEY == L1.L_ORDERKEY
            and I.Nkey == S1.S_NATIONKEY and S1.S_SUPPKEY == L1.L_SUPPKEY and I.Rkey != N1.N_REGIONKEY)
group by I.Nkey ORDER BY I.value DESC;